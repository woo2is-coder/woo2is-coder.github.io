<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì†ì„±ë³„ ì„œìš¸ ëœë“œë§ˆí¬ ì´ë¯¸ì§€ ë¹„êµ ì‹¤í—˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      color: #111827;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
      font-weight: 700;
    }
    h1 { font-size: 1.6rem; }
    h2 { font-size: 1.3rem; }
    p {
      margin: 4px 0;
      line-height: 1.6;
    }
    .small {
      font-size: 0.88rem;
      color: #4b5563;
    }
    .card {
      margin-top: 16px;
      background: white;
      border-radius: 18px;
      padding: 20px 18px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    .hidden { display: none; }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      margin-top: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: white;
      margin-top: 16px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 7px 22px rgba(37,99,235,0.4);
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #1d4ed8;
      box-shadow: 0 10px 28px rgba(37,99,235,0.5);
    }
    button:disabled {
      background: #cbd5f5;
      box-shadow: none;
      cursor: not-allowed;
    }

    .trial-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      font-size: 0.9rem;
      color: #4b5563;
    }

    .phase-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: #e5e7eb;
      color: #374151;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#2563eb,#22c55e);
      transition: width 0.2s ease;
    }

    /* ì¹´ë“œ + ê°€ìš´ë° ì†ì„± ë™ê·¸ë¼ë¯¸ */
    .choice-layout {
      display: grid;
      grid-template-columns: minmax(0,1fr) auto minmax(0,1fr);
      gap: 18px;
      margin-top: 10px;
      align-items: center;
    }
    .choice-card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 14px 12px;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-height: 220px;
    }
    .choice-label {
      font-weight: 700;
      text-align: center;
      margin-bottom: 6px;
    }
    .choice-desc {
      font-size: 0.9rem;
      color: #4b5563;
      text-align: center;
    }

    .img-wrapper {
      width: 100%;
      max-width: 220px;
      aspect-ratio: 4 / 3;
      border-radius: 14px;
      overflow: hidden;
      background: #e5e7eb;
      margin-bottom: 10px;
    }
    .img-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .attr-circle {
      width: 110px;
      height: 110px;
      border-radius: 999px;
      background: #ffffff;
      border: 3px solid #22c55e;
      box-shadow: 0 6px 18px rgba(34,197,94,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 8px;
      font-weight: 700;
      font-size: 1rem;
      color: #0ea5e9;
    }

    /* ì²™ë„: ìŠ¤í¬ë¡¤ ì—†ì´ í•œ ì¤„ì— 7ê°œ */
    .scale-row {
      margin-top: 18px;
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      gap: 4px;
      overflow-x: hidden;
      padding-bottom: 0;
    }

    .scale-btn {
      flex: 1 1 0;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.72rem;
      padding: 4px 2px;
      cursor: pointer;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      text-align: center;
      white-space: normal;
    }
    .scale-btn:hover {
      border-color: #2563eb;
      box-shadow: 0 4px 14px rgba(37,99,235,0.25);
      background: #eff6ff;
    }
    .scale-value-tag {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    .key-hint {
      margin-top: 10px;
      text-align: center;
      font-size: 0.9rem;
      color: #4b5563;
    }

    ul.result-list {
      padding-left: 16px;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    ul.result-list li {
      margin: 4px 0;
    }

    @media (max-width: 720px) {
      h1 { font-size: 1.35rem; }
      .choice-layout { grid-template-columns: 1fr; }
      .attr-circle {
        order: -1;
        margin: 0 auto 8px auto;
      }
      .choice-card { min-height: 180px; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- ì‹œì‘ í™”ë©´ -->
  <div id="start-screen" class="card">
    <h1>ì†ì„±ë³„ ì„œìš¸ ëœë“œë§ˆí¬ ì´ë¯¸ì§€ ë¹„êµ ì‹¤í—˜</h1>
    <p class="small">
      ì´ ì‹¤í—˜ì€ ì„œìš¸ì˜ ì£¼ìš” ëœë“œë§ˆí¬ë¥¼ ë³¼ ë•Œ,<br/>
      <b>ì—­ì‚¬ì„±, ë¬¸í™”ì„±, ìƒì§•ì„±, í˜„ëŒ€ì„±</b>ê³¼ ê°™ì€ ì†ì„± ê¸°ì¤€ì—ì„œ<br/>
      <b>ì–´ëŠ ëœë“œë§ˆí¬ë¥¼ ì–¼ë§ˆë‚˜ ë” ì„ í˜¸í•˜ëŠ”ì§€</b>ë¥¼
      <u>ì„ í˜¸ ê°•ë„(7,5,3,1 ì²™ë„)ì™€ ë°˜ì‘ì‹œê°„</u>ìœ¼ë¡œ ì•Œì•„ë³´ê¸° ìœ„í•œ ì¡°ì‚¬ì…ë‹ˆë‹¤.
    </p>
    <p class="small">
      ì‹¤í—˜ì´ ëë‚˜ë©´ ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡ë˜ë©°,<br/>
      ì°¸ê°€ìëŠ” ë³„ë„ì˜ íŒŒì¼ì„ ë³´ë‚´ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
    </p>

    <label class="small">
      ì°¸ê°€ì ID (ë‹‰ë„¤ì„/ë²ˆí˜¸ ë“± ììœ ë¡­ê²Œ)
      <input type="text" id="participant-id" placeholder="ì˜ˆ: S001, í™ê¸¸ë™, 2025-01 ë“±" />
    </label>

    <button id="start-btn">ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- ì†ì„± ë¸”ë¡ ì•ˆë‚´ í™”ë©´ -->
  <div id="attr-block-intro" class="card hidden">
    <h2 id="attr-block-title"></h2>
    <p class="small" id="attr-block-desc"></p>
    <p class="small">
      ì´ ê¸°ì¤€ë§Œ ìƒê°í•˜ë©´ì„œ,<br/>
      ê° í™”ë©´ì—ì„œ <b>ë‘˜ ì¤‘ ì–´ëŠ ëœë“œë§ˆí¬ê°€ ë” ê·¸ ê¸°ì¤€ì— ì˜ ë§ëŠ”ì§€,</b><br/>
      ê·¸ë¦¬ê³  <b>ì–¼ë§ˆë‚˜ ë” ê·¸ëŸ°ì§€(7,5,3,1)</b>ë¥¼ ì•„ë˜ ë²„íŠ¼ ì¤‘ í•˜ë‚˜ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.
    </p>
    <p class="small">
      ì²™ë„ ì•ˆë‚´ ì˜ˆì‹œ:<br/>
      7 = ë§¤ìš° ê°•í•˜ê²Œ ìš°ì„¸, 5 = ê°•í•˜ê²Œ ìš°ì„¸,<br/>
      3 = ë¹„êµì  ìš°ì„¸, 1 = ë‘ ëœë“œë§ˆí¬ê°€ ê±°ì˜ ë¹„ìŠ·í•¨
    </p>
    <button id="attr-block-start-btn">ì´ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘</button>
  </div>

  <!-- ë©”ì¸ ë¹„êµ í™”ë©´ -->
  <div id="trial-screen" class="card hidden">
    <div class="trial-header">
      <div>
        <span class="phase-pill" id="current-attr-label-pill"></span>
      </div>
      <div id="trial-counter"></div>
    </div>

    <div class="progress-bar">
      <div id="progress-inner" class="progress-bar-inner"></div>
    </div>

    <p class="small" style="margin-top:12px;" id="trial-question"></p>

    <div class="choice-layout">
      <div id="left-card" class="choice-card">
        <div class="img-wrapper">
          <img id="left-img" src="" alt="ì™¼ìª½ ëœë“œë§ˆí¬ ì´ë¯¸ì§€" />
        </div>
        <div class="choice-label" id="left-label"></div>
        <div class="choice-desc" id="left-desc"></div>
      </div>

      <div class="attr-circle">
        <span id="attr-circle-label"></span>
      </div>

      <div id="right-card" class="choice-card">
        <div class="img-wrapper">
          <img id="right-img" src="" alt="ì˜¤ë¥¸ìª½ ëœë“œë§ˆí¬ ì´ë¯¸ì§€" />
        </div>
        <div class="choice-label" id="right-label"></div>
        <div class="choice-desc" id="right-desc"></div>
      </div>
    </div>

    <div class="scale-row">
      <button class="scale-btn" data-side="left" data-scale="7">
        <span class="scale-value-tag">7</span>
        ì™¼ìª½ ë§¤ìš° ê°•í•˜ê²Œ ìš°ì„¸
      </button>
      <button class="scale-btn" data-side="left" data-scale="5">
        <span class="scale-value-tag">5</span>
        ì™¼ìª½ ê°•í•˜ê²Œ ìš°ì„¸
      </button>
      <button class="scale-btn" data-side="left" data-scale="3">
        <span class="scale-value-tag">3</span>
        ì™¼ìª½ ë¹„êµì  ìš°ì„¸
      </button>

      <button class="scale-btn" data-side="equal" data-scale="1">
        <span class="scale-value-tag">1</span>
        ë‘ ëœë“œë§ˆí¬ ë¹„ìŠ·
      </button>

      <button class="scale-btn" data-side="right" data-scale="3">
        <span class="scale-value-tag">3</span>
        ì˜¤ë¥¸ìª½ ë¹„êµì  ìš°ì„¸
      </button>
      <button class="scale-btn" data-side="right" data-scale="5">
        <span class="scale-value-tag">5</span>
        ì˜¤ë¥¸ìª½ ê°•í•˜ê²Œ ìš°ì„¸
      </button>
      <button class="scale-btn" data-side="right" data-scale="7">
        <span class="scale-value-tag">7</span>
        ì˜¤ë¥¸ìª½ ë§¤ìš° ê°•í•˜ê²Œ ìš°ì„¸
      </button>
    </div>

    <div class="key-hint">
      <span class="small">ê° ë¹„êµë§ˆë‹¤ ìœ„ì˜ 7Â·5Â·3Â·1Â·3Â·5Â·7 ë²„íŠ¼ ì¤‘ í•˜ë‚˜ë§Œ ì§ê´€ì ìœ¼ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.</span>
    </div>
  </div>

  <!-- ì¢…ë£Œ í™”ë©´ -->
  <div id="end-screen" class="card hidden">
    <h2>ì‹¤í—˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ™Œ</h2>
    <p class="small" id="upload-status">
      ê²°ê³¼ë¥¼ ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </p>

    <ul class="result-list" id="summary-list"></ul>

    <button id="download-btn">ë°±ì—…ìš© ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ</button>
    <p class="small">
      (ì—°êµ¬ìì—ê²ŒëŠ” ìë™ìœ¼ë¡œ ì „ì†¡ë˜ë¯€ë¡œ, CSV íŒŒì¼ì„ ë”°ë¡œ ë³´ë‚´ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.)  
    </p>
  </div>

</div>

<script>
  // â˜…â˜…â˜… ë„¤ê°€ ì¤€ Apps Script ì›¹ì•± URL ê·¸ëŒ€ë¡œ ë„£ì–´ë‘  â˜…â˜…â˜…
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyyAnnmkwWZnOBJiJrUAgWk7BGPia2XgjDMdWMhwZej8JxZFPYfP4m2Z2R5wWMHcsD1-A/exec";

  const attributes = [
    {
      id: "history",
      label: "ì—­ì‚¬ì„±",
      question: "ì—­ì‚¬ì„±(ì˜¤ëœ ì—­ì‚¬ì™€ ì „í†µ)ì„ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "ì–¼ë§ˆë‚˜ ì˜¤ë˜ë˜ì—ˆê³  ì—­ì‚¬ì  ì˜ë¯¸ê°€ ìˆëŠ”ê°€"
    },
    {
      id: "culture",
      label: "ë¬¸í™”ì„±",
      question: "ë¬¸í™”ì„±(ë¬¸í™”Â·ì˜ˆìˆ Â·ì²´í—˜ ìš”ì†Œ)ì„ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "ë¬¸í™”Â·ì˜ˆìˆ Â·ì²´í—˜ ê³µê°„ìœ¼ë¡œì„œì˜ ëŠë‚Œ"
    },
    {
      id: "symbol",
      label: "ìƒì§•ì„± Â· ì¸ì§€ë„",
      question: "ìƒì§•ì„±Â·ì¸ì§€ë„(ì„œìš¸ì„ ëŒ€í‘œí•˜ëŠ” ìƒì§•ì„±)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "ì„œìš¸ í•˜ë©´ ê°€ì¥ ë¨¼ì € ë– ì˜¤ë¥´ëŠ” ì¥ì†Œì¸ê°€?"
    },
    {
      id: "modernity",
      label: "í˜„ëŒ€ì„± Â· ê±´ì¶•ë¯¸",
      question: "í˜„ëŒ€ì„±Â·ê±´ì¶•ë¯¸(í˜„ëŒ€ì  ì´ë¯¸ì§€ì™€ ë””ìì¸)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "ì–¼ë§ˆë‚˜ í˜„ëŒ€ì ì´ê³  ì‹œê°ì ìœ¼ë¡œ ì„¸ë ¨ë˜ê²Œ ë³´ì´ëŠ”ê°€"
    }
  ];

  const alternatives = [
    {
      id: "gyeongbokgung",
      name: "ê²½ë³µê¶",
      desc: "ì¡°ì„ ì™•ì¡°ì˜ ë²•ê¶ìœ¼ë¡œ, ì„œìš¸ì˜ ëŒ€í‘œì ì¸ ì „í†µ ê¶ê¶ê³¼ ì—­ì‚¬ ìœ ì‚°",
      img: "img/gyeongbokgung.jpg"
    },
    {
      id: "namsan",
      name: "ë‚¨ì‚°íƒ€ì›Œ(Nì„œìš¸íƒ€ì›Œ)",
      desc: "ì„œìš¸ ì „ê²½ê³¼ ì•¼ê²½ì„ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì„œìš¸ì˜ ëŒ€í‘œ ì „ë§ íƒ€ì›Œ",
      img: "img/namsan.jpg"
    },
    {
      id: "ddp",
      name: "DDP(ë™ëŒ€ë¬¸ë””ìì¸í”Œë¼ì)",
      desc: "ë¯¸ë˜ì§€í–¥ì  ê³¡ì„  ë””ìì¸ì˜ í˜„ëŒ€ì  ê±´ì¶•ë¬¼, ì „ì‹œÂ·ë¬¸í™” í–‰ì‚¬ê°€ ì—´ë¦¬ëŠ” ê³µê°„",
      img: "img/ddp.jpg"
    },
    {
      id: "lotte",
      name: "ë¡¯ë°ì›”ë“œíƒ€ì›Œ",
      desc: "123ì¸µ ì´ˆê³ ì¸µ ë¹Œë”©ìœ¼ë¡œ, ì„œìš¸ì˜ í˜„ëŒ€ì  ìŠ¤ì¹´ì´ë¼ì¸ì„ ëŒ€í‘œí•˜ëŠ” ëœë“œë§ˆí¬",
      img: "img/lotte.jpg"
    }
  ];

  let participantId = "";
  let currentAttrIndex = -1;
  let currentAttrTrials = [];
  let currentTrialIndex = -1;
  let stimulusOnsetTime = null;
  let awaitingResponse = false;
  let results = [];

  const startScreen = document.getElementById("start-screen");
  const attrBlockIntro = document.getElementById("attr-block-intro");
  const trialScreen = document.getElementById("trial-screen");
  const endScreen = document.getElementById("end-screen");

  const startBtn = document.getElementById("start-btn");
  const participantInput = document.getElementById("participant-id");

  const attrBlockTitle = document.getElementById("attr-block-title");
  const attrBlockDesc = document.getElementById("attr-block-desc");
  const attrBlockStartBtn = document.getElementById("attr-block-start-btn");

  const currentAttrLabelPill = document.getElementById("current-attr-label-pill");
  const trialCounter = document.getElementById("trial-counter");
  const progressInner = document.getElementById("progress-inner");
  const trialQuestion = document.getElementById("trial-question");

  const leftImg = document.getElementById("left-img");
  const rightImg = document.getElementById("right-img");
  const leftLabel = document.getElementById("left-label");
  const leftDesc = document.getElementById("left-desc");
  const rightLabel = document.getElementById("right-label");
  const rightDesc = document.getElementById("right-desc");

  const attrCircleLabel = document.getElementById("attr-circle-label");
  const scaleButtons = document.querySelectorAll(".scale-btn");

  const summaryList = document.getElementById("summary-list");
  const downloadBtn = document.getElementById("download-btn");
  const uploadStatus = document.getElementById("upload-status");

  function showScreen(screen) {
    [startScreen, attrBlockIntro, trialScreen, endScreen].forEach(el => el.classList.add("hidden"));
    screen.classList.remove("hidden");
  }

  function shuffle(array) {
    const arr = array.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function generateAlternativePairs() {
    const pairs = [];
    for (let i = 0; i < alternatives.length; i++) {
      for (let j = i + 1; j < alternatives.length; j++) {
        pairs.push({ a: alternatives[i], b: alternatives[j] });
      }
    }
    const trials = pairs.map(pair => {
      if (Math.random() < 0.5) {
        return { left: pair.a, right: pair.b };
      } else {
        return { left: pair.b, right: pair.a };
      }
    });
    return shuffle(trials);
  }

  function preloadAlternativeImages() {
    alternatives.forEach(alt => {
      if (alt.img) {
        const img = new Image();
        img.src = alt.img;
      }
    });
  }

  startBtn.addEventListener("click", () => {
    const id = participantInput.value.trim();
    if (!id) {
      alert("ì°¸ê°€ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    participantId = id;

    preloadAlternativeImages();

    currentAttrIndex = -1;
    results = [];

    goToNextAttributeBlock();
  });

  function goToNextAttributeBlock() {
    currentAttrIndex++;
    if (currentAttrIndex >= attributes.length) {
      finishExperiment();
      return;
    }

    const attr = attributes[currentAttrIndex];
    attrBlockTitle.textContent = `ê¸°ì¤€: ${attr.label}`;
    attrBlockDesc.textContent =
      `ì´ì œë¶€í„°ëŠ” "${attr.label}" ê¸°ì¤€ìœ¼ë¡œ ì„œìš¸ ëœë“œë§ˆí¬ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.\n` +
      `(ì˜ˆ: ${attr.desc})`;

    showScreen(attrBlockIntro);
  }

  attrBlockStartBtn.addEventListener("click", () => {
    currentAttrTrials = generateAlternativePairs();
    currentTrialIndex = -1;
    startNextTrial();
  });

  function startNextTrial() {
    awaitingResponse = false;
    stimulusOnsetTime = null;

    currentTrialIndex++;
    if (currentTrialIndex >= currentAttrTrials.length) {
      goToNextAttributeBlock();
      return;
    }

    const attr = attributes[currentAttrIndex];
    const trial = currentAttrTrials[currentTrialIndex];

    currentAttrLabelPill.textContent = `ê¸°ì¤€: ${attr.label}`;
    attrCircleLabel.textContent = attr.label;

    const trialNum = currentTrialIndex + 1;
    const total = currentAttrTrials.length;
    trialCounter.textContent = `ì´ ê¸°ì¤€ì—ì„œ Trial ${trialNum} / ${total}`;

    const progress = (trialNum / total) * 100;
    progressInner.style.width = progress.toFixed(1) + "%";

    trialQuestion.textContent =
      `${attr.question} ë‘ ëœë“œë§ˆí¬ ì¤‘ ì–´ëŠ ìª½ì´ ë” ê·¸ ê¸°ì¤€ì— ì˜ ë§ëŠ”ì§€, ê·¸ë¦¬ê³  ê·¸ ì°¨ì´ëŠ” ì–´ëŠ ì •ë„ì¸ê°€ìš”?`;

    leftLabel.textContent = trial.left.name;
    leftDesc.textContent = trial.left.desc;
    leftImg.src = trial.left.img;

    rightLabel.textContent = trial.right.name;
    rightDesc.textContent = trial.right.desc;
    rightImg.src = trial.right.img;

    showScreen(trialScreen);

    setTimeout(() => {
      stimulusOnsetTime = performance.now();
      awaitingResponse = true;
    }, 200);
  }

  scaleButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const side = btn.getAttribute("data-side");
      const scale = parseInt(btn.getAttribute("data-scale"), 10);
      handleScaleChoice(side, scale, "mouse");
    });
  });

  function handleScaleChoice(side, scaleValue, inputType) {
    if (!awaitingResponse) return;

    const now = performance.now();
    const rt = stimulusOnsetTime ? Math.round(now - stimulusOnsetTime) : null;
    awaitingResponse = false;

    const trial = currentAttrTrials[currentTrialIndex];
    const attr = attributes[currentAttrIndex];

    let chosen, other;
    let chosen_side = side;
    let signedScore = 0;

    if (side === "left") {
      chosen = trial.left;
      other = trial.right;
      signedScore = scaleValue;
    } else if (side === "right") {
      chosen = trial.right;
      other = trial.left;
      signedScore = -scaleValue;
    } else {
      chosen = null;
      other = null;
      signedScore = 0;
    }

    const globalTrialIndex = results.length;

    results.push({
      participant_id: participantId,
      attribute_id: attr.id,
      attribute_label: attr.label,
      attribute_index: currentAttrIndex,
      trial_index_within_attr: currentTrialIndex,
      global_trial_index: globalTrialIndex,
      left_id: trial.left.id,
      left_name: trial.left.name,
      right_id: trial.right.id,
      right_name: trial.right.name,
      chosen_side: chosen_side,
      scale_value: scaleValue,
      signed_score: signedScore,
      chosen_id: chosen ? chosen.id : "",
      chosen_name: chosen ? chosen.name : "",
      other_id: other ? other.id : "",
      other_name: other ? other.name : "",
      rt_ms: rt,
      input_type: inputType,
      timestamp: new Date().toISOString()
    });

    setTimeout(() => startNextTrial(), 150);
  }

  function finishExperiment() {
    showScreen(endScreen);
    makeSummary();
    uploadResultsToGoogle();
  }

  function makeSummary() {
    summaryList.innerHTML = "";

    const totalTrials = results.length;
    const li1 = document.createElement("li");
    li1.textContent = `ì „ì²´ trial ìˆ˜: ${totalTrials} (ì†ì„± 4ê°œ Ã— ê° 6í˜ì–´)`;
    summaryList.appendChild(li1);

    const meanRT = calcMeanRT();
    const li2 = document.createElement("li");
    li2.textContent =
      `ì „ì²´ í‰ê·  ë°˜ì‘ì‹œê°„: ${meanRT != null ? meanRT + " ms" : "ê³„ì‚° ë¶ˆê°€"}`;
    summaryList.appendChild(li2);

    const li3 = document.createElement("li");
    li3.textContent = `ì°¸ê°€ì ID: ${participantId}`;
    summaryList.appendChild(li3);
  }

  function calcMeanRT() {
    const subset = results.filter(r => r.rt_ms != null);
    if (!subset.length) return null;
    const sum = subset.reduce((acc, r) => acc + r.rt_ms, 0);
    return Math.round(sum / subset.length);
  }

  // ------- Google Sheet ì—…ë¡œë“œ (no-cors ëª¨ë“œ) -------
  async function uploadResultsToGoogle() {
    if (!results.length || !GOOGLE_SCRIPT_URL) {
      uploadStatus.textContent =
        "ì—…ë¡œë“œ ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì—°êµ¬ììš©: Apps Script URLì„ ì½”ë“œì— ë„£ì–´ì£¼ì„¸ìš”.)";
      return;
    }

    uploadStatus.textContent = "ê²°ê³¼ë¥¼ ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({ records: results })
      });

      uploadStatus.textContent =
        "ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ê²°ê³¼ ì „ì†¡ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë°ì´í„°ê°€ ì˜ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.";
    } catch (err) {
      console.error(err);
      uploadStatus.textContent =
        "ê²°ê³¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•„ë˜ CSV ë‹¤ìš´ë¡œë“œë¥¼ ëˆŒëŸ¬ íŒŒì¼ë¡œ ì €ì¥í•´ ì£¼ì„¸ìš”.";
    }
  }

  // ------- CSV ë°±ì—… ë‹¤ìš´ë¡œë“œ -------
  function downloadCSV() {
    if (!results.length) {
      alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const headers = [
      "participant_id",
      "attribute_id",
      "attribute_label",
      "attribute_index",
      "trial_index_within_attr",
      "global_trial_index",
      "left_id",
      "left_name",
      "right_id",
      "right_name",
      "chosen_side",
      "scale_value",
      "signed_score",
      "chosen_id",
      "chosen_name",
      "other_id",
      "other_name",
      "rt_ms",
      "input_type",
      "timestamp"
    ];

    const rows = results.map(r => [
      r.participant_id,
      r.attribute_id,
      r.attribute_label,
      r.attribute_index,
      r.trial_index_within_attr,
      r.global_trial_index,
      r.left_id,
      r.left_name,
      r.right_id,
      r.right_name,
      r.chosen_side,
      r.scale_value,
      r.signed_score,
      r.chosen_id,
      r.chosen_name,
      r.other_id,
      r.other_name,
      r.rt_ms,
      r.input_type,
      r.timestamp
    ]);

    const csvContent = [
      headers.join(","),
      ...rows.map(row =>
        row
          .map(v => {
            if (v == null) return "";
            const s = String(v);
            if (s.includes(",") || s.includes('"')) {
              return '"' + s.replace(/"/g, '""') + '"';
            }
            return s;
          })
          .join(",")
      )
    ].join("\r\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const dateStr = new Date().toISOString().replace(/[:.]/g, "-");
    a.href = url;
    a.download = `seoul_landmark_IHA_${participantId}_${dateStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener("click", downloadCSV);
</script>
</body>
</html>
