<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì†ì„±ë³„ ì„œìš¸ ëœë“œë§ˆí¬ ì´ë¯¸ì§€ ë¹„êµ ì‹¤í—˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f3f4f6;
    color: #111827;
  }
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px 14px 40px;
  }

  h1, h2 {
    margin: 0 0 8px;
    font-weight: 700;
  }
  h1 { font-size: 1.6rem; letter-spacing: -0.03em; }
  h2 { font-size: 1.35rem; letter-spacing: -0.02em; }

  p {
    margin: 4px 0;
    line-height: 1.6;
  }
  .small {
    font-size: 0.9rem;
    color: #4b5563;
  }

  .card {
    margin-top: 16px;
    background: #ffffff;
    border-radius: 20px;
    padding: 18px 16px 20px;
    box-shadow: 0 14px 35px rgba(15, 23, 42, 0.12);
  }

  .hidden { display: none; }

  input[type="text"] {
    width: 100%;
    padding: 9px 11px;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    font-size: 0.95rem;
    margin-top: 4px;
  }

  button {
    border: none;
    border-radius: 999px;
    padding: 11px 24px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    background: #2563eb;
    color: white;
    margin-top: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    box-shadow: 0 9px 25px rgba(37,99,235,0.45);
    transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.2s ease;
  }
  button:hover:not(:disabled) {
    transform: translateY(-1px);
    background: #1d4ed8;
    box-shadow: 0 12px 30px rgba(37,99,235,0.55);
  }
  button:disabled {
    background: #cbd5f5;
    box-shadow: none;
    cursor: not-allowed;
  }

  .trial-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 0.9rem;
    color: #4b5563;
  }

  .phase-pill {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 0.8rem;
    background: #e5e7eb;
    color: #374151;
  }

  .progress-bar {
    width: 100%;
    height: 7px;
    border-radius: 999px;
    background: #e5e7eb;
    overflow: hidden;
    margin-top: 4px;
  }
  .progress-bar-inner {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg,#2563eb,#22c55e);
    transition: width 0.2s ease;
  }

  /* ----- ëœë“œë§ˆí¬ / ì†ì„± ì¹´ë“œ + ì†ì„± ë™ê·¸ë¼ë¯¸ ----- */
  #trial-question {
    margin-top: 14px;
    font-size: 0.95rem;
    color: #111827;
  }

  .choice-layout {
    display: grid;
    grid-template-columns: minmax(0,1.05fr) auto minmax(0,1.05fr);
    gap: 14px;
    margin-top: 14px;
    align-items: flex-start;
  }
  .choice-card {
    background: #f9fafb;
    border-radius: 18px;
    padding: 10px 8px 14px;
    border: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 190px;
  }
  .choice-label {
    font-weight: 700;
    font-size: 1rem;
    text-align: center;
    margin-bottom: 4px;
  }
  .choice-desc {
    font-size: 0.85rem;
    color: #4b5563;
    text-align: center;
  }

  .img-wrapper {
    width: 100%;
    max-width: 260px;
    aspect-ratio: 4 / 3;
    border-radius: 16px;
    overflow: hidden;
    background: #e5e7eb;
    margin-bottom: 8px;
  }
  .img-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .attr-circle {
    width: 78px;
    height: 78px;
    border-radius: 999px;
    background: #ffffff;
    border: 3px solid #22c55e;
    box-shadow: 0 6px 18px rgba(34,197,94,0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 4px;
    font-weight: 700;
    font-size: 0.9rem;
    color: #0ea5e9;
  }

  /* ì†ì„± ì¤‘ìš”ë„ ë‹¨ê³„ì—ì„œëŠ” ì´ë¯¸ì§€ ìˆ¨ê¸°ê¸° */
  body.phase-importance .img-wrapper {
    display: none;
  }
  body.phase-importance .choice-card {
    min-height: 120px;
    padding-top: 16px;
  }

  /* ----- ì²™ë„ ì˜ì—­ ----- */
  .scale-row-wrapper {
    margin-top: 18px;
    padding: 10px 10px 12px;
    border-radius: 16px;
    background: linear-gradient(180deg,#eef2ff,#ffffff);
  }

  .scale-row {
    display: flex;
    flex-wrap: nowrap;
    justify-content: space-between;
    gap: 6px;
    overflow-x: hidden;
  }

  .scale-btn {
    flex: 1 1 0;
    min-width: 0;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    padding: 9px 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 1rem;
    font-weight: 700;
    color: #111827;
  }
  .scale-btn:hover {
    border-color: #2563eb;
    box-shadow: 0 4px 14px rgba(37,99,235,0.25);
    background: #eff6ff;
  }
  .scale-btn:active {
    background: #2563eb;
    color: #ffffff;
  }

  .scale-caption {
    margin-top: 6px;
    font-size: 0.78rem;
    color: #6b7280;
    text-align: center;
    line-height: 1.4;
  }

  .key-hint {
    margin-top: 6px;
    text-align: center;
    font-size: 0.82rem;
    color: #4b5563;
  }

  ul.result-list {
    padding-left: 16px;
    margin-top: 8px;
    font-size: 0.9rem;
  }
  ul.result-list li {
    margin: 4px 0;
  }

  /* ----- ëª¨ë°”ì¼ íŠœë‹ ----- */
  @media (max-width: 720px) {
    h1 { font-size: 1.4rem; }
    .container { padding: 18px 10px 34px; }
    .card { padding: 16px 12px 18px; border-radius: 18px; }

    .choice-layout {
      grid-template-columns: minmax(0,1.05fr) auto minmax(0,1.05fr);
      gap: 10px;
    }
    .choice-card {
      padding: 8px 4px 12px;
      min-height: 160px;
    }
    .img-wrapper {
      max-width: 100%;
      aspect-ratio: 4 / 3;
    }
    .attr-circle {
      width: 70px;
      height: 70px;
      font-size: 0.8rem;
    }
    .scale-btn {
      font-size: 0.95rem;
      padding: 8px 0;
    }
  }
</style>

</head>
<body>
<div class="container">

  <!-- ì‹œì‘ í™”ë©´ -->
  <div id="start-screen" class="card">
    <h1>ì†ì„±ë³„ ì„œìš¸ ëœë“œë§ˆí¬ ì´ë¯¸ì§€ ë¹„êµ ì‹¤í—˜</h1>
    <p class="small">
      ì´ ì‹¤í—˜ì€ ì„œìš¸ì˜ ì£¼ìš” ëœë“œë§ˆí¬ë¥¼ ë³¼ ë•Œ,<br/>
      <b>ì—­ì‚¬ì„±, ë¬¸í™”ì„±, ìƒì§•ì„±, í˜„ëŒ€ì„±</b> ê¸°ì¤€ì—ì„œ<br/>
      <b>ì–´ëŠ ëœë“œë§ˆí¬ë¥¼ ì–¼ë§ˆë‚˜ ë” ì„ í˜¸í•˜ëŠ”ì§€</b>ë¥¼
      <u>ì„ í˜¸ ê°•ë„(7Â·5Â·3Â·1 ì²™ë„)ì™€ ë°˜ì‘ì‹œê°„</u>ìœ¼ë¡œ ì•Œì•„ë³´ê¸° ìœ„í•œ ì¡°ì‚¬ì…ë‹ˆë‹¤.
    </p>
    <p class="small">
      ë¨¼ì € ë„¤ ê°€ì§€ ê¸°ì¤€(ì†ì„±) ì‚¬ì´ì˜ <b>ì¤‘ìš”ë„ ë¹„êµ</b>ë¥¼ ì§„í–‰í•œ ë’¤,<br/>
      ê° ê¸°ì¤€ë³„ë¡œ ëœë“œë§ˆí¬ë¥¼ ë¹„êµí•˜ê²Œ ë©ë‹ˆë‹¤.
    </p>
    <p class="small">
      ì‹¤í—˜ì´ ëë‚˜ë©´ ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ì— ì „ì†¡ë˜ë©°,<br/>
      ì°¸ê°€ìëŠ” ë³„ë„ì˜ íŒŒì¼ì„ ë³´ë‚´ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
    </p>

    <label class="small">
      ì°¸ê°€ì ID (ë‹‰ë„¤ì„/ë²ˆí˜¸ ë“± ììœ ë¡­ê²Œ)
      <input type="text" id="participant-id" placeholder="ì˜ˆ: S001, í™ê¸¸ë™, 2025-01 ë“±" />
    </label>

    <button id="start-btn">ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- 1ë‹¨ê³„: ì†ì„± ì¤‘ìš”ë„ ë¹„êµ ì•ˆë‚´ -->
  <div id="importance-intro" class="card hidden">
    <h2>1ë‹¨ê³„: ê¸°ì¤€(ì†ì„±) ì¤‘ìš”ë„ ë¹„êµ</h2>
    <p class="small">
      ë¨¼ì €, ì„œìš¸ ëœë“œë§ˆí¬ë¥¼ ë– ì˜¬ë¦´ ë•Œ <b>ì–´ë–¤ ê¸°ì¤€(ì†ì„±)ì„ ë” ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ”ì§€</b>ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
    </p>
    <p class="small">
      ê° í™”ë©´ë§ˆë‹¤ ë‘ ê¸°ì¤€(ì˜ˆ: ì—­ì‚¬ì„± vs í˜„ëŒ€ì„±)ì´ ì œì‹œë˜ë©°,<br/>
      ë” ì¤‘ìš”í•˜ë‹¤ê³  ëŠë¼ëŠ” ìª½ê³¼ ê·¸ ì •ë„ë¥¼ <b>7Â·5Â·3Â·1Â·3Â·5Â·7</b> ì¤‘ í•˜ë‚˜ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.
    </p>
    <button id="importance-start-btn">ê¸°ì¤€ ì¤‘ìš”ë„ ë¹„êµ ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- 2ë‹¨ê³„: ì†ì„±ë³„ ëœë“œë§ˆí¬ ë¹„êµ ì „ ì•ˆë‚´ í™”ë©´ -->
  <div id="attr-block-intro" class="card hidden">
    <h2 id="attr-block-title"></h2>
    <p class="small" id="attr-block-desc"></p>
    <button id="attr-block-start-btn">ì´ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘</button>
  </div>

  <!-- ë©”ì¸ ë¹„êµ í™”ë©´ (ì†ì„± ì¤‘ìš”ë„ + ëœë“œë§ˆí¬ ë¹„êµì—ì„œ ê³µí†µ ì‚¬ìš©) -->
  <div id="trial-screen" class="card hidden">
    <div class="trial-header">
      <div>
        <span class="phase-pill" id="current-attr-label-pill"></span>
      </div>
      <div id="trial-counter"></div>
    </div>

    <div class="progress-bar">
      <div id="progress-inner" class="progress-bar-inner"></div>
    </div>

    <p class="small" style="margin-top:12px;" id="trial-question"></p>

    <div class="choice-layout">
      <div id="left-card" class="choice-card">
        <div class="img-wrapper">
          <img id="left-img" src="" alt="ì™¼ìª½ ì´ë¯¸ì§€" />
        </div>
        <div class="choice-label" id="left-label"></div>
        <div class="choice-desc" id="left-desc"></div>
      </div>

      <div class="attr-circle">
        <span id="attr-circle-label"></span>
      </div>

      <div id="right-card" class="choice-card">
        <div class="img-wrapper">
          <img id="right-img" src="" alt="ì˜¤ë¥¸ìª½ ì´ë¯¸ì§€" />
        </div>
        <div class="choice-label" id="right-label"></div>
        <div class="choice-desc" id="right-desc"></div>
      </div>
    </div>

    <div class="scale-row-wrapper">
      <div class="scale-row">
        <!-- 7 5 3 1 3 5 7 ìˆ«ìë§Œ í¬ê²Œ -->
        <button class="scale-btn" data-side="left" data-scale="7">7</button>
        <button class="scale-btn" data-side="left" data-scale="5">5</button>
        <button class="scale-btn" data-side="left" data-scale="3">3</button>
        <button class="scale-btn" data-side="equal" data-scale="1">1</button>
        <button class="scale-btn" data-side="right" data-scale="3">3</button>
        <button class="scale-btn" data-side="right" data-scale="5">5</button>
        <button class="scale-btn" data-side="right" data-scale="7">7</button>
      </div>
      <div class="scale-caption">
        ì™¼ìª½ ë§¤ìš° ê°•í•¨(7) Â· ì™¼ìª½ ê°•í•¨(5) Â· ì™¼ìª½ ë¹„êµì (3) Â· ë¹„ìŠ·í•¨(1) Â· ì˜¤ë¥¸ìª½ ë¹„êµì (3) Â· ì˜¤ë¥¸ìª½ ê°•í•¨(5) Â· ì˜¤ë¥¸ìª½ ë§¤ìš° ê°•í•¨(7)
      </div>
    </div>

    <div class="key-hint">
      ê° ë¹„êµë§ˆë‹¤ ìœ„ì˜ <b>7Â·5Â·3Â·1Â·3Â·5Â·7</b> ë²„íŠ¼ ì¤‘ <b>í•˜ë‚˜ë§Œ</b> ê³¨ë¼ ì£¼ì„¸ìš”.
    </div>
  </div>

  <!-- ì¢…ë£Œ í™”ë©´ -->
  <div id="end-screen" class="card hidden">
    <h2>ì‹¤í—˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ™Œ</h2>
    <p class="small" id="upload-status">
      ê²°ê³¼ë¥¼ ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </p>

    <ul class="result-list" id="summary-list"></ul>

    <button id="download-btn">ë°±ì—…ìš© ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ</button>
    <p class="small">
      (ì—°êµ¬ìì—ê²ŒëŠ” ìë™ìœ¼ë¡œ ì „ì†¡ë˜ë¯€ë¡œ, CSV íŒŒì¼ì„ ë”°ë¡œ ë³´ë‚´ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.)
    </p>
  </div>

</div>

<script>
  // â˜… ë„¤ Apps Script ì›¹ì•± URL â˜…
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyyAnnmkwWZnOBJiJrUAgWk7BGPia2XgjDMdWMhwZej8JxZFPYfP4m2Z2R5wWMHcsD1-A/exec";

  // 4ê°œ ê¸°ì¤€(ì†ì„±) ì •ì˜
  const attributes = [
    {
      id: "history",
      label: "ì—­ì‚¬ì„±",
      question: "ì—­ì‚¬ì„±(ì˜¤ëœ ì—­ì‚¬ Â· ì—­ì‚¬ì  ì˜ë¯¸ Â· ì „í†µ)ì„ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "ì–¼ë§ˆë‚˜ ì˜¤ë˜ë˜ì—ˆê³  ì—­ì‚¬ì  ì˜ë¯¸ë¥¼ ì§€ë‹ˆëŠ”ì§€ì— ì´ˆì ì„ ë§ì¶° íŒë‹¨í•´ì£¼ì„¸ìš”."
    },
    {
      id: "culture",
      label: "ë¬¸í™”ì„±",
      question: "ë¬¸í™”ì„±(ë¬¸í™”Â·ì˜ˆìˆ Â·ì²´í—˜ ìš”ì†Œ)ì„ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "ë¬¸í™”Â·ì˜ˆìˆ Â·ì²´í—˜ í™œë™ê³¼ ì–¼ë§ˆë‚˜ ì˜ ì—°ê²°ë˜ëŠ”ì§€ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨í•´ì£¼ì„¸ìš”."
    },
    {
      id: "symbol",
      label: "ìƒì§•ì„± Â· ì¸ì§€ë„",
      question: "ìƒì§•ì„±Â·ì¸ì§€ë„(ì„œìš¸ í•˜ë©´ ë– ì˜¤ë¥´ëŠ” ëŒ€í‘œ ì´ë¯¸ì§€)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "â€˜ì„œìš¸ í•˜ë©´ ë– ì˜¤ë¥´ëŠ” ëŒ€í‘œ ì´ë¯¸ì§€ì¸ê°€â€™ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨í•´ì£¼ì„¸ìš”."
    },
    {
      id: "modernity",
      label: "í˜„ëŒ€ì„± Â· ê±´ì¶•ë¯¸",
      question: "í˜„ëŒ€ì„±Â·ê±´ì¶•ë¯¸(í˜„ëŒ€ì Â·ì„¸ë ¨ëœ)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³¼ ë•Œ,",
      desc: "ì–¼ë§ˆë‚˜ í˜„ëŒ€ì ì´ê³  ì„¸ë ¨ëœ ê±´ì¶•Â·ë””ìì¸ ëŠë‚Œì¸ì§€ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨í•´ì£¼ì„¸ìš”."
    }
  ];

  // ëœë“œë§ˆí¬(ëŒ€ì•ˆ)
  const alternatives = [
    {
      id: "gyeongbokgung",
      name: "ê²½ë³µê¶",
      desc: "",
      img: "img/gyeongbokgung.jpg"
    },
    {
      id: "namsan",
      name: "ë‚¨ì‚°íƒ€ì›Œ(Nì„œìš¸íƒ€ì›Œ)",
      desc: "",
      img: "img/namsan.jpg"
    },
    {
      id: "ddp",
      name: "DDP(ë™ëŒ€ë¬¸ë””ìì¸í”Œë¼ì)",
      desc: "",
      img: "img/ddp.jpg"
    },
    {
      id: "lotte",
      name: "ë¡¯ë°ì›”ë“œíƒ€ì›Œ",
      desc: "",
      img: "img/lotte.jpg"
    }
  ];

  let participantId = "";

  // í˜„ì¬ ë‹¨ê³„: "importance" (ì†ì„± ì¤‘ìš”ë„) / "attribute" (ì†ì„±ë³„ ëœë“œë§ˆí¬ ë¹„êµ)
  let currentPhase = "importance";

  // 1ë‹¨ê³„: ì†ì„± ì¤‘ìš”ë„ ë¹„êµìš©
  let importanceTrials = [];
  let currentImportanceIndex = -1;

  // 2ë‹¨ê³„: ì†ì„±ë³„ ëœë“œë§ˆí¬ ë¹„êµìš©
  let currentAttrIndex = -1;      // attributesì—ì„œ ëª‡ ë²ˆì§¸ ì†ì„±ì¸ì§€
  let currentAttrTrials = [];     // í•´ë‹¹ ì†ì„±ì—ì„œì˜ ëœë“œë§ˆí¬ í˜ì–´ ëª©ë¡
  let currentTrialIndex = -1;     // ê·¸ ì†ì„± ì•ˆì—ì„œ ëª‡ ë²ˆì§¸ trialì¸ì§€

  let stimulusOnsetTime = null;
  let awaitingResponse = false;
  let results = [];

  // DOM ì°¸ì¡°
  const startScreen = document.getElementById("start-screen");
  const importanceIntro = document.getElementById("importance-intro");
  const attrBlockIntro = document.getElementById("attr-block-intro");
  const trialScreen = document.getElementById("trial-screen");
  const endScreen = document.getElementById("end-screen");

  const startBtn = document.getElementById("start-btn");
  const participantInput = document.getElementById("participant-id");

  const importanceStartBtn = document.getElementById("importance-start-btn");

  const attrBlockTitle = document.getElementById("attr-block-title");
  const attrBlockDesc = document.getElementById("attr-block-desc");
  const attrBlockStartBtn = document.getElementById("attr-block-start-btn");

  const currentAttrLabelPill = document.getElementById("current-attr-label-pill");
  const trialCounter = document.getElementById("trial-counter");
  const progressInner = document.getElementById("progress-inner");
  const trialQuestion = document.getElementById("trial-question");

  const leftImg = document.getElementById("left-img");
  const rightImg = document.getElementById("right-img");
  const leftLabel = document.getElementById("left-label");
  const leftDesc = document.getElementById("left-desc");
  const rightLabel = document.getElementById("right-label");
  const rightDesc = document.getElementById("right-desc");

  const attrCircleLabel = document.getElementById("attr-circle-label");
  const scaleButtons = document.querySelectorAll(".scale-btn");

  const summaryList = document.getElementById("summary-list");
  const downloadBtn = document.getElementById("download-btn");
  const uploadStatus = document.getElementById("upload-status");

  function showScreen(screen) {
    [startScreen, importanceIntro, attrBlockIntro, trialScreen, endScreen].forEach(el => el.classList.add("hidden"));
    screen.classList.remove("hidden");
  }

  function shuffle(array) {
    const arr = array.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ì†ì„± ì¤‘ìš”ë„ ë¹„êµìš© í˜ì–´(4ê°œ ê¸°ì¤€ â†’ 6í˜ì–´)
  function generateAttributePairs() {
    const pairs = [];
    for (let i = 0; i < attributes.length; i++) {
      for (let j = i + 1; j < attributes.length; j++) {
        pairs.push({ a: attributes[i], b: attributes[j] });
      }
    }
    // left/right ëœë¤ ìœ„ì¹˜
    const trials = pairs.map(pair => {
      if (Math.random() < 0.5) {
        return { left: pair.a, right: pair.b };
      } else {
        return { left: pair.b, right: pair.a };
      }
    });
    return shuffle(trials);
  }

  // ëœë“œë§ˆí¬ í˜ì–´(4ê°œ â†’ 6í˜ì–´)
  function generateAlternativePairs() {
    const pairs = [];
    for (let i = 0; i < alternatives.length; i++) {
      for (let j = i + 1; j < alternatives.length; j++) {
        pairs.push({ a: alternatives[i], b: alternatives[j] });
      }
    }
    const trials = pairs.map(pair => {
      if (Math.random() < 0.5) {
        return { left: pair.a, right: pair.b };
      } else {
        return { left: pair.b, right: pair.a };
      }
    });
    return shuffle(trials);
  }

  function preloadAlternativeImages() {
    alternatives.forEach(alt => {
      if (alt.img) {
        const img = new Image();
        img.src = alt.img;
      }
    });
  }

  // ì‹œì‘ ë²„íŠ¼
  startBtn.addEventListener("click", () => {
    const id = participantInput.value.trim();
    if (!id) {
      alert("ì°¸ê°€ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    participantId = id;

    preloadAlternativeImages();

    // 1ë‹¨ê³„: ì†ì„± ì¤‘ìš”ë„ ë¹„êµë¶€í„° ì‹œì‘
    currentPhase = "importance";
    importanceTrials = generateAttributePairs();
    currentImportanceIndex = -1;
    showScreen(importanceIntro);
  });

  // 1ë‹¨ê³„ ì‹œì‘
  importanceStartBtn.addEventListener("click", () => {
    currentPhase = "importance";
    document.body.classList.add("phase-importance");
    currentImportanceIndex = -1;
    startNextImportanceTrial();
  });

  // 1ë‹¨ê³„: ì†ì„± ì¤‘ìš”ë„ trial ì§„í–‰
  function startNextImportanceTrial() {
    awaitingResponse = false;
    stimulusOnsetTime = null;

    currentImportanceIndex++;
    const total = importanceTrials.length;

    if (currentImportanceIndex >= total) {
      // 1ë‹¨ê³„ ë â†’ 2ë‹¨ê³„(ì†ì„±ë³„ ëœë“œë§ˆí¬ ë¹„êµ)ë¡œ ì´ë™
      document.body.classList.remove("phase-importance");
      currentAttrIndex = -1;
      goToNextAttributeBlock();
      return;
    }

    const trial = importanceTrials[currentImportanceIndex];

    currentAttrLabelPill.textContent = "1ë‹¨ê³„: ê¸°ì¤€ ì¤‘ìš”ë„ ë¹„êµ";
    attrCircleLabel.textContent = "ì¤‘ìš”ë„";

    const trialNum = currentImportanceIndex + 1;
    trialCounter.textContent = `ê¸°ì¤€ ì¤‘ìš”ë„ Trial ${trialNum} / ${total}`;

    const progress = (trialNum / total) * 100;
    progressInner.style.width = progress.toFixed(1) + "%";

    trialQuestion.textContent =
      "ë‘ ê¸°ì¤€ ì¤‘ ì„œìš¸ ëœë“œë§ˆí¬ë¥¼ ë– ì˜¬ë¦´ ë•Œ ë” ì¤‘ìš”í•˜ë‹¤ê³  ëŠë¼ëŠ” ìª½ê³¼ ê·¸ ì •ë„ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.";

    // ì†ì„± í…ìŠ¤íŠ¸ë§Œ ì‚¬ìš© (ì´ë¯¸ì§€ëŠ” ìˆ¨ê²¨ë‘” ìƒíƒœ)
    leftLabel.textContent = trial.left.label;
    leftDesc.textContent = trial.left.desc;
    leftImg.src = "";

    rightLabel.textContent = trial.right.label;
    rightDesc.textContent = trial.right.desc;
    rightImg.src = "";

    showScreen(trialScreen);

    setTimeout(() => {
      stimulusOnsetTime = performance.now();
      awaitingResponse = true;
    }, 200);
  }

  // 2ë‹¨ê³„: ì†ì„±ë³„ ëœë“œë§ˆí¬ ë¹„êµ ì•ˆë‚´ í™”ë©´ìœ¼ë¡œ ì´ë™
  function goToNextAttributeBlock() {
    currentAttrIndex++;
    if (currentAttrIndex >= attributes.length) {
      finishExperiment();
      return;
    }

    const attr = attributes[currentAttrIndex];
    attrBlockTitle.textContent = `2ë‹¨ê³„: ê¸°ì¤€ "${attr.label}" ê¸°ì¤€ ë¹„êµ`;
    attrBlockDesc.textContent =
      `ì´ì œë¶€í„°ëŠ” "${attr.label}" ê¸°ì¤€ìœ¼ë¡œ ì„œìš¸ ëœë“œë§ˆí¬ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.\n` +
      `(ì˜ˆ: ${attr.desc})`;

    showScreen(attrBlockIntro);
  }

  // 2ë‹¨ê³„: í•´ë‹¹ ê¸°ì¤€ì—ì„œ ëœë“œë§ˆí¬ ë¹„êµ ì‹œì‘
  attrBlockStartBtn.addEventListener("click", () => {
    currentPhase = "attribute";
    document.body.classList.remove("phase-importance");
    currentAttrTrials = generateAlternativePairs();
    currentTrialIndex = -1;
    startNextAttributeTrial();
  });

  // 2ë‹¨ê³„: ì†ì„±ë³„ ëœë“œë§ˆí¬ trial ì§„í–‰
  function startNextAttributeTrial() {
    awaitingResponse = false;
    stimulusOnsetTime = null;

    currentTrialIndex++;
    if (currentTrialIndex >= currentAttrTrials.length) {
      goToNextAttributeBlock();
      return;
    }

    const attr = attributes[currentAttrIndex];
    const trial = currentAttrTrials[currentTrialIndex];

    currentAttrLabelPill.textContent = `2ë‹¨ê³„: ê¸°ì¤€ ${attr.label}`;
    attrCircleLabel.textContent = attr.label;

    const trialNum = currentTrialIndex + 1;
    const total = currentAttrTrials.length;
    trialCounter.textContent = `ì´ ê¸°ì¤€ì—ì„œ Trial ${trialNum} / ${total}`;

    const progress = (trialNum / total) * 100;
    progressInner.style.width = progress.toFixed(1) + "%";

    trialQuestion.textContent =
      `${attr.question} ë‘ ëœë“œë§ˆí¬ ì¤‘ ê¸°ì¤€ì— ë” ì˜ ë§ëŠ” ê³³ê³¼ ê·¸ ì •ë„ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.`;

    leftLabel.textContent = trial.left.name;
    leftDesc.textContent = trial.left.desc;
    leftImg.src = trial.left.img;

    rightLabel.textContent = trial.right.name;
    rightDesc.textContent = trial.right.desc;
    rightImg.src = trial.right.img;

    showScreen(trialScreen);

    setTimeout(() => {
      stimulusOnsetTime = performance.now();
      awaitingResponse = true;
    }, 200);
  }

  // ì²™ë„ ë²„íŠ¼ ê³µí†µ ì²˜ë¦¬
  scaleButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const side = btn.getAttribute("data-side");
      const scale = parseInt(btn.getAttribute("data-scale"), 10);
      handleScaleChoice(side, scale, "mouse");
    });
  });

  function handleScaleChoice(side, scaleValue, inputType) {
    if (!awaitingResponse) return;

    const now = performance.now();
    const rt = stimulusOnsetTime ? Math.round(now - stimulusOnsetTime) : null;
    awaitingResponse = false;

    let record = null;

    if (currentPhase === "importance") {
      // 1ë‹¨ê³„: ì†ì„± ì¤‘ìš”ë„ ë¹„êµ
      const trial = importanceTrials[currentImportanceIndex];
      const attrMeta = { id: "importance", label: "ì†ì„±ì¤‘ìš”ë„" };

      let chosen = null;
      let other = null;
      let signedScore = 0;
      const chosen_side = side;

      if (side === "left") {
        chosen = trial.left;
        other = trial.right;
        signedScore = scaleValue;
      } else if (side === "right") {
        chosen = trial.right;
        other = trial.left;
        signedScore = -scaleValue;
      } else {
        signedScore = 0;
      }

      record = {
        participant_id: participantId,
        attribute_id: attrMeta.id,
        attribute_label: attrMeta.label,
        attribute_index: -1,
        trial_index_within_attr: currentImportanceIndex,
        global_trial_index: results.length,
        left_id: trial.left.id,
        left_name: trial.left.label,
        right_id: trial.right.id,
        right_name: trial.right.label,
        chosen_side: chosen_side,
        scale_value: scaleValue,
        signed_score: signedScore,
        chosen_id: chosen ? chosen.id : "",
        chosen_name: chosen ? chosen.label : "",
        other_id: other ? other.id : "",
        other_name: other ? other.label : "",
        rt_ms: rt,
        input_type: inputType,
        timestamp: new Date().toISOString()
      };

      results.push(record);
      setTimeout(() => startNextImportanceTrial(), 150);
      return;
    }

    // 2ë‹¨ê³„: ì†ì„±ë³„ ëœë“œë§ˆí¬ ë¹„êµ
    const trial = currentAttrTrials[currentTrialIndex];
    const attr = attributes[currentAttrIndex];

    let chosen, other;
    let chosen_side = side;
    let signedScore = 0;

    if (side === "left") {
      chosen = trial.left;
      other = trial.right;
      signedScore = scaleValue;
    } else if (side === "right") {
      chosen = trial.right;
      other = trial.left;
      signedScore = -scaleValue;
    } else {
      chosen = null;
      other = null;
      signedScore = 0;
    }

    record = {
      participant_id: participantId,
      attribute_id: attr.id,
      attribute_label: attr.label,
      attribute_index: currentAttrIndex,
      trial_index_within_attr: currentTrialIndex,
      global_trial_index: results.length,
      left_id: trial.left.id,
      left_name: trial.left.name,
      right_id: trial.right.id,
      right_name: trial.right.name,
      chosen_side: chosen_side,
      scale_value: scaleValue,
      signed_score: signedScore,
      chosen_id: chosen ? chosen.id : "",
      chosen_name: chosen ? chosen.name : "",
      other_id: other ? other.id : "",
      other_name: other ? other.name : "",
      rt_ms: rt,
      input_type: inputType,
      timestamp: new Date().toISOString()
    };

    results.push(record);
    setTimeout(() => startNextAttributeTrial(), 150);
  }

  function finishExperiment() {
    showScreen(endScreen);
    makeSummary();
    uploadResultsToGoogle();
  }

  function makeSummary() {
    summaryList.innerHTML = "";

    const totalTrials = results.length;
    const li1 = document.createElement("li");
    li1.textContent = `ì „ì²´ trial ìˆ˜: ${totalTrials} (ì†ì„± ì¤‘ìš”ë„ 6í˜ì–´ + ëœë“œë§ˆí¬ ë¹„êµ ê¸°ì¤€ 4ê°œ Ã— ê° 6í˜ì–´)`;
    summaryList.appendChild(li1);

    const meanRT = calcMeanRT();
    const li2 = document.createElement("li");
    li2.textContent =
      `ì „ì²´ í‰ê·  ë°˜ì‘ì‹œê°„: ${meanRT != null ? meanRT + " ms" : "ê³„ì‚° ë¶ˆê°€"}`;
    summaryList.appendChild(li2);

    const li3 = document.createElement("li");
    li3.textContent = `ì°¸ê°€ì ID: ${participantId}`;
    summaryList.appendChild(li3);
  }

  function calcMeanRT() {
    const subset = results.filter(r => r.rt_ms != null);
    if (!subset.length) return null;
    const sum = subset.reduce((acc, r) => acc + r.rt_ms, 0);
    return Math.round(sum / subset.length);
  }

  // Google Sheet ì—…ë¡œë“œ (no-cors)
  async function uploadResultsToGoogle() {
    if (!results.length || !GOOGLE_SCRIPT_URL) {
      uploadStatus.textContent =
        "ì—…ë¡œë“œ ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì—°êµ¬ììš©: Apps Script URLì„ ì½”ë“œì— ë„£ì–´ì£¼ì„¸ìš”.)";
      return;
    }

    uploadStatus.textContent = "ê²°ê³¼ë¥¼ ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

    try {
      await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({ records: results })
      });

      uploadStatus.textContent =
        "ì—°êµ¬ìì˜ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ê²°ê³¼ ì „ì†¡ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë°ì´í„°ê°€ ì˜ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.";
    } catch (err) {
      console.error(err);
      uploadStatus.textContent =
        "ê²°ê³¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•„ë˜ CSV ë‹¤ìš´ë¡œë“œë¥¼ ëˆŒëŸ¬ íŒŒì¼ë¡œ ì €ì¥í•´ ì£¼ì„¸ìš”.";
    }
  }

  // CSV ë°±ì—… ë‹¤ìš´ë¡œë“œ
  function downloadCSV() {
    if (!results.length) {
      alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const headers = [
      "participant_id",
      "attribute_id",
      "attribute_label",
      "attribute_index",
      "trial_index_within_attr",
      "global_trial_index",
      "left_id",
      "left_name",
      "right_id",
      "right_name",
      "chosen_side",
      "scale_value",
      "signed_score",
      "chosen_id",
      "chosen_name",
      "other_id",
      "other_name",
      "rt_ms",
      "input_type",
      "timestamp"
    ];

    const rows = results.map(r => [
      r.participant_id,
      r.attribute_id,
      r.attribute_label,
      r.attribute_index,
      r.trial_index_within_attr,
      r.global_trial_index,
      r.left_id,
      r.left_name,
      r.right_id,
      r.right_name,
      r.chosen_side,
      r.scale_value,
      r.signed_score,
      r.chosen_id,
      r.chosen_name,
      r.other_id,
      r.other_name,
      r.rt_ms,
      r.input_type,
      r.timestamp
    ]);

    const csvContent = [
      headers.join(","),
      ...rows.map(row =>
        row
          .map(v => {
            if (v == null) return "";
            const s = String(v);
            if (s.includes(",") || s.includes('"')) {
              return '"' + s.replace(/"/g, '""') + '"';
            }
            return s;
          })
          .join(",")
      )
    ].join("\r\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const dateStr = new Date().toISOString().replace(/[:.]/g, "-");
    a.href = url;
    a.download = `seoul_landmark_IHA_${participantId}_${dateStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener("click", downloadCSV);
</script>
</body>
</html>
